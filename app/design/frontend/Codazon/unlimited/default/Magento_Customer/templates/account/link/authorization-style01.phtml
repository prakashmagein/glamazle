<?php
/**
 * Copyright Â© 2017 Codazon, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

/** @var \Magento\Customer\Block\Account\AuthorizationLink $block */
$dataPostParam = '';
$styleClass = 'authorization-style-01';
$helper = $this->helper('Codazon\\ThemeLayoutPro\\Helper\\Data');
$displayStyle = $this->getData('display_style') ?: ($helper->getAccountPanelStyle() ?: 'dropdown');
$fullActionName = $block->getRequest()->getFullActionName();
$shouldRenderUtilities = $fullActionName !== 'checkout_cart_index';
$greetingTemplate = $helper->getConfig('themelayoutpro/header/customer_greeting_format');

if ($shouldRenderUtilities) {
    $utilitiesHtml = $block->getBlockHtml('utilities.content');
} else {
    /**
     * Rendering utilities.content on the cart page is expensive because the block
     * rebuilds the entire account dashboard each time. Replace it with a
     * lightweight fallback so the cart page renders faster while still offering
     * the key navigation links.
     */
    $utilitiesHtml = '<ul class="account-utilities">';
    if ($block->isLoggedIn()) {
        $utilitiesHtml .= sprintf('<li><a href="%s">%s</a></li>', $block->escapeUrl($block->getUrl('customer/account')), __('My Account'));
        $utilitiesHtml .= sprintf('<li><a href="%s">%s</a></li>', $block->escapeUrl($block->getUrl('customer/account/logout')), __('Sign Out'));
    } else {
        $utilitiesHtml .= sprintf('<li><a href="%s">%s</a></li>', $block->escapeUrl($block->getUrl('customer/account/login')), __('Sign In'));
        $utilitiesHtml .= sprintf('<li><a href="%s">%s</a></li>', $block->escapeUrl($block->getUrl('customer/account/create')), __('Create an Account'));
    }
    $utilitiesHtml .= '</ul>';
}

$greetingHtml = $greetingTemplate
    ? str_replace(['{{firstname}}', '{{fullname}}'], ['<span data-customerinfo="firstname"></span>', '<span data-customerinfo="fullname"></span>'], $greetingTemplate)
    : __('Hello %1', '<span data-customerinfo="firstname"></span>');
?>
<!-- authorization style 01 -->
<?php if ($displayStyle == 'sidebar') : ?>
    <?php $direction = $this->getData('direction') ?: 'right'; ?>
    <?php if ($block->isLoggedIn()) : ?>
    <?php $dataPostParam = sprintf(" data-post='%s'", $block->getPostParams()); ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="account-wrapper">
            <a href="javascript:;" class="account-trigger cdz-top-link" data-sidebartrigger='{"side": "<?= $direction ?>"}'>
                <span class="text-underlink"><?= /* @noEscape */ $greetingHtml ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
        </div>
    </li>
    <?php else : ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="account-wrapper">
            <a href="javascript:;" class="account-trigger cdz-top-link" data-sidebartrigger='{"side": "<?= $direction ?>"}'>
                <span class="text-underlink"><?= __('Hello, sign in'); ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
        </div>
    </li>
    <?php endif ?>
<?php elseif ($displayStyle == 'popup') : ?>
    <?php if ($block->isLoggedIn()) : ?>
    <?php $dataPostParam = sprintf(" data-post='%s'", $block->getPostParams()); ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="account-wrapper">
            <a href="javascript:;" class="account-trigger cdz-top-link" data-cdzpopuptrigger="account-popup">
                <span class="text-underlink"><?= /* @noEscape */ $greetingHtml ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
        </div>
    </li>
    <?php else : ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="account-wrapper">
            <a href="javascript:;" class="account-trigger cdz-top-link" data-cdzpopuptrigger="account-popup">
                <span class="text-underlink"><?= __('Hello, sign in'); ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
        </div>
    </li>
    <?php endif ?>
    <div style="display:none">
        <div class="md-dialog-container account-popup" data-cdzpopup id="account-popup">
            <div class="md-dialog-inner">
                <?= /* @noEscape */ $utilitiesHtml; ?>
                <?= $block->getChildHtml(); ?>
            </div>
        </div>
    </div>
<?php else : /* dropdown */ ?>
    <?php if ($block->isLoggedIn()) : ?>
    <?php $dataPostParam = sprintf(" data-post='%s'", $block->getPostParams()); ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="cdz-dropdown account-wrapper" data-role="cdz-dropdown">
            <a href="javascript:void(0)" class="account-trigger cdz-dd-trigger cdz-top-link" data-role="cdz-dd-trigger">
                <span class="text-underlink"><?= /* @noEscape */ $greetingHtml ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
            <div class="cdz-dd-content" data-role="cdz-dd-content">
                <div class="cdz-dd-content-inner nice-scroll">
                    <?= /* @noEscape */ $utilitiesHtml; ?>
                    <?= $block->getChildHtml(); ?>
                </div>
            </div>
        </div>
    </li>
    <?php else : ?>
    <li class="authorization-link <?= $styleClass ?>">
        <div class="cdz-dropdown account-wrapper" data-role="cdz-dropdown">
            <a href="javascript:void(0)" class="account-trigger cdz-dd-trigger cdz-top-link" data-role="cdz-dd-trigger">
                <span class="text-underlink"><?= __('Hello, sign in'); ?></span>
                <span class="text-uppercase"><?= __('Your account'); ?></span>
            </a>
            <div class="cdz-dd-content" data-role="cdz-dd-content">
                <div class="cdz-dd-content-inner nice-scroll">
                    <?= /* @noEscape */ $utilitiesHtml; ?>
                    <?= $block->getChildHtml(); ?>
                </div>
            </div>
        </div>
    </li>
    <?php endif ?>
<?php endif ?>
